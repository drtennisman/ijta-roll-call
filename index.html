<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#021f3d">
    <title>IJTA Roll App</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(180deg, #052d54 0%, #021f3d 100%);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .header-logo {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            flex-shrink: 0;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .header h1 {
            font-size: 19px;
            font-weight: 700;
            letter-spacing: 0.4px;
            line-height: 1.2;
        }

        .header .subtitle {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 3px;
            font-weight: 600;
            letter-spacing: 1.2px;
            text-transform: uppercase;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Screen management */
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }

        /* Clinic Selection Screen */
        .clinic-btn {
            display: block;
            width: 100%;
            padding: 16px 20px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            color: #333;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .clinic-btn:active {
            background: #e8eef5;
            border-color: #021f3d;
        }

        .clinic-btn .clinic-icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .clinic-btn[data-clinic*="Red"] .clinic-icon { background: #e53935; }
        .clinic-btn[data-clinic*="Orange"] .clinic-icon { background: #fb8c00; }
        .clinic-btn[data-clinic*="Green"] .clinic-icon { background: #43a047; }
        .clinic-btn[data-clinic*="Middle"] .clinic-icon { background: #fdd835; }
        .clinic-btn[data-clinic*="High"] .clinic-icon { background: #fdd835; }
        .clinic-btn[data-clinic*="Bruno"] .clinic-icon { background: #1565c0; }

        /* Section headers */
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 20px 0 10px 0;
        }

        .section-title:first-child {
            margin-top: 4px;
        }

        /* Checklist items */
        .checklist {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.1s;
            -webkit-user-select: none;
            user-select: none;
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-item:active {
            background: #f5f5f5;
        }

        .checklist-item.checked {
            background: #e8eef5;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #ccc;
            border-radius: 6px;
            margin-right: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .checklist-item.checked .checkbox {
            background: #021f3d;
            border-color: #021f3d;
        }

        .checkbox .checkmark {
            display: none;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .checklist-item.checked .checkbox .checkmark {
            display: block;
        }

        .checklist-item .name {
            font-size: 16px;
            flex-grow: 1;
        }

        /* Select All */
        .select-all-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 6px;
        }

        .select-all-btn {
            font-size: 13px;
            color: #021f3d;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            padding: 4px 0;
        }

        /* Back button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.85);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            padding: 4px 0;
            transition: color 0.15s;
        }

        .back-btn:active {
            color: white;
        }

        .header-inner {
            position: relative;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 14px;
            max-width: 600px;
            margin: 0 auto;
        }

        .header-text {
            display: flex;
            flex-direction: column;
        }

        /* Submit button */
        .submit-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .submit-btn {
            display: block;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
            background: #021f3d;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }

        .submit-btn:disabled {
            background: #7a9ab8;
            cursor: not-allowed;
        }

        .submit-btn:active:not(:disabled) {
            background: #011529;
        }

        /* Counter badge */
        .counter {
            font-size: 13px;
            color: #666;
            font-weight: normal;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .loading .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid #e0e0e0;
            border-top-color: #021f3d;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success overlay */
        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .overlay.active {
            display: flex;
        }

        .overlay-content {
            background: white;
            border-radius: 16px;
            padding: 32px 24px;
            text-align: center;
            max-width: 320px;
            margin: 20px;
        }

        .overlay-content .success-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .overlay-content h2 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .overlay-content p {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .overlay-content button {
            padding: 12px 32px;
            background: #021f3d;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Error state */
        .error-msg {
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            display: none;
        }

        .error-msg.visible {
            display: block;
        }

        /* Bottom padding for fixed submit bar */
        .roll-screen-content {
            padding-bottom: 80px;
        }

        /* Player count summary */
        .summary-line {
            font-size: 13px;
            color: #888;
            margin-top: 6px;
        }

        /* Member/Guest badge */
        .badge {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .badge.member {
            background: #e8eef5;
            color: #021f3d;
        }

        .badge.guest {
            background: #fff3e0;
            color: #e65100;
        }

        .badge.social {
            background: #e8f5e9;
            color: #2e7d32;
        }

        /* Date picker */
        .date-picker-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .date-picker-label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .date-picker-input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            color: #333;
            outline: none;
            transition: border-color 0.15s;
        }

        .date-picker-input:focus {
            border-color: #021f3d;
        }

        /* Add player section */
        .add-player-bar {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .add-player-type {
            padding: 12px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            color: #333;
            outline: none;
            cursor: pointer;
            transition: border-color 0.15s;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
        }

        .add-player-type:focus {
            border-color: #021f3d;
        }

        .add-player-input {
            flex-grow: 1;
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.15s;
        }

        .add-player-input:focus {
            border-color: #021f3d;
        }

        .add-player-input::placeholder {
            color: #bbb;
        }

        .add-player-btn {
            padding: 12px 18px;
            background: #021f3d;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }

        .add-player-btn:active {
            background: #011529;
        }

        .added-tag {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            background: #e3f2fd;
            color: #1565c0;
            margin-left: 8px;
            flex-shrink: 0;
        }

        /* Total juniors tracker */
        .total-juniors-bar {
            margin-top: 20px;
            padding: 16px 20px;
            background: linear-gradient(135deg, #052d54 0%, #021f3d 100%);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(2, 31, 61, 0.25);
        }

        .total-juniors-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .total-juniors-label {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .total-juniors-count {
            font-size: 28px;
            font-weight: 700;
            color: white;
            line-height: 1;
        }

        .total-juniors-breakdown {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.12);
        }

        .breakdown-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .breakdown-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .breakdown-dot.member {
            background: #64b5f6;
        }

        .breakdown-dot.guest {
            background: #ffb74d;
        }

        .breakdown-dot.social {
            background: #81c784;
        }

        .breakdown-text {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            font-weight: 500;
        }

        .breakdown-num {
            font-size: 13px;
            color: white;
            font-weight: 700;
        }
    </style>
</head>
<body>

    <!-- Clinic Selection Screen -->
    <div id="clinic-screen" class="screen active">
        <div class="header">
            <div class="header-inner">
                <img src="ijta-logo.png" alt="IJTA Logo" class="header-logo">
                <div class="header-text">
                    <h1>IJTA Roll App</h1>
                    <div class="subtitle">Select a Clinic</div>
                </div>
            </div>
        </div>
        <div class="container">
            <div id="clinic-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading clinics...</div>
                </div>
            </div>
            <div id="total-juniors" class="total-juniors-bar" style="display:none;">
                <div class="total-juniors-top">
                    <span class="total-juniors-label">Total Juniors</span>
                    <span class="total-juniors-count" id="total-juniors-count">0</span>
                </div>
                <div class="total-juniors-breakdown">
                    <div class="breakdown-item">
                        <span class="breakdown-dot member"></span>
                        <span class="breakdown-text">Members</span>
                        <span class="breakdown-num" id="total-members-count">0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-dot guest"></span>
                        <span class="breakdown-text">Guests</span>
                        <span class="breakdown-num" id="total-guests-count">0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-dot social"></span>
                        <span class="breakdown-text">Social</span>
                        <span class="breakdown-num" id="total-social-count">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Roll Taking Screen -->
    <div id="roll-screen" class="screen">
        <div class="header">
            <div class="header-inner">
                <button class="back-btn" onclick="showClinicScreen()">&#8592; Back</button>
                <img src="ijta-logo.png" alt="IJTA Logo" class="header-logo">
                <div class="header-text">
                    <h1 id="selected-clinic-name">Clinic Name</h1>
                    <div class="subtitle" id="roll-date"></div>
                </div>
            </div>
        </div>
        <div class="container roll-screen-content">
            <div id="error-message" class="error-msg"></div>

            <div class="date-picker-bar">
                <span class="date-picker-label">Date</span>
                <input type="date" id="roll-date-input" class="date-picker-input">
            </div>

            <div class="section-title">Coaches</div>
            <div id="coaches-list" class="checklist"></div>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="section-title">Players <span id="player-counter" class="counter"></span></div>
                <div class="select-all-bar">
                    <button class="select-all-btn" onclick="toggleSelectAllPlayers()">Select All</button>
                </div>
            </div>
            <div id="players-list" class="checklist"></div>

            <div class="add-player-bar">
                <input type="text" id="add-player-input" class="add-player-input" placeholder="Last, First (e.g. Smith, John)">
                <select id="add-player-type" class="add-player-type">
                    <option value="M">Member</option>
                    <option value="G">Guest</option>
                    <option value="S">Social</option>
                </select>
                <button class="add-player-btn" onclick="addPlayer()">+ Add</button>
            </div>
        </div>
        <div class="submit-bar">
            <button class="submit-btn" id="submit-btn" onclick="submitRoll()">Submit Attendance</button>
        </div>
    </div>

    <!-- Success Overlay -->
    <div id="success-overlay" class="overlay">
        <div class="overlay-content">
            <div class="success-icon">&#10003;</div>
            <h2>Submitted!</h2>
            <p id="success-message">Attendance has been recorded.</p>
            <button onclick="dismissSuccess()">Done</button>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        // New roster sheet — one tab per clinic
        const ROSTER_SHEET_ID = '10nb7o9ZJ-fRyTnA2wosGa6OBCTZeEcGAKRAuCY7PZ8E';

        // Maps clinic display names to their tab names in the spreadsheet
        const CLINICS = [
            { name: 'Red Ball (Ages 8 and Under)', display: 'Red Ball', tab: 'Red Ball' },
            { name: 'Orange Ball (Ages 10 and Under)', display: 'Orange Ball', tab: 'Orange Ball' },
            { name: 'Green Ball (Ages 12 and Under)', display: 'Green Ball', tab: 'Green Ball' },
            { name: 'Middle School Yellow Ball Clinic (Ages 12-14)', display: 'MS Yellow Ball', tab: 'Middle School' },
            { name: 'High School Yellow Ball Clinic (Ages 14 and Over)', display: 'HS Yellow Ball', tab: 'High School' },
            { name: 'Bruno', display: 'Bruno', tab: 'Bruno', hideBadge: true }
        ];

        // Google Apps Script Web App URL
        let APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz2i4kNaZorfM-7UJUefmcTGSWMKnHDckOca44VSG_vYai0UafjxHX2EMfGtU6n3jVP_A/exec';

        const COACHES = [
            'Becca Mathis',
            'Caleb Mathis',
            'Ellis Zapalowski',
            'J.C. Freeman',
            'Joey Francis',
            'John Lacy',
            'Lake Blackiston',
            'Matt Kendrick',
            'Stephanie Heckler',
            'Steve Prokop'
        ];

        // ==================== STATE ====================
        let rosterData = {};  // { clinicName: [ { name: "Last, First", status: "M"|"G" } ] }
        let selectedClinic = null;  // the clinic object from CLINICS

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadAllRosters();
            checkAppsScriptUrl();
        });

        function checkAppsScriptUrl() {
            if (!APPS_SCRIPT_URL) {
                APPS_SCRIPT_URL = localStorage.getItem('ijta_apps_script_url') || '';
            }
        }

        // ==================== ROSTER LOADING ====================
        async function loadAllRosters() {
            try {
                document.getElementById('clinic-list').innerHTML =
                    '<div class="loading"><div class="spinner"></div><div>Loading clinics...</div></div>';

                // Fetch all clinic tabs in parallel
                const fetches = CLINICS.map(clinic => loadClinicRoster(clinic));
                await Promise.all(fetches);
                renderClinicList();
            } catch (error) {
                console.error('Error loading rosters:', error);
                document.getElementById('clinic-list').innerHTML =
                    '<div class="error-msg visible">Failed to load rosters. Please check your internet connection and try again.</div>';
            }
        }

        async function loadClinicRoster(clinic) {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${ROSTER_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(clinic.tab)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to fetch ${clinic.tab}`);
                const csvText = await response.text();
                rosterData[clinic.name] = parseClinicCSV(csvText);
            } catch (error) {
                console.error(`Error loading ${clinic.tab}:`, error);
                rosterData[clinic.name] = [];
            }
        }

        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                if (inQuotes) {
                    if (char === '"') {
                        if (i + 1 < row.length && row[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = false;
                        }
                    } else {
                        current += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseClinicCSV(csvText) {
            const players = [];
            const lines = csvText.split('\n').filter(line => line.trim());

            // Skip header row (Last Name, First Name, Status)
            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVRow(lines[i]);
                const lastName = (cols[0] || '').trim();
                const firstName = (cols[1] || '').trim();
                const rawStatus = (cols[2] || 'M').trim().toUpperCase();

                if (!lastName && !firstName) continue;

                // Accept "G", "Guest", "S", "Social", "M", "Member" (or anything else defaults to Member)
                const isGuest = rawStatus === 'G' || rawStatus === 'GUEST';
                const isSocial = rawStatus === 'S' || rawStatus === 'SOCIAL';
                const status = isGuest ? 'G' : isSocial ? 'S' : 'M';

                const displayName = firstName ? `${lastName}, ${firstName}` : lastName;
                players.push({
                    name: displayName,
                    status: status
                });
            }

            // Sort alphabetically by last name (already "Last, First")
            players.sort((a, b) => a.name.localeCompare(b.name));
            return players;
        }

        // ==================== CLINIC SELECTION ====================
        function renderClinicList() {
            const container = document.getElementById('clinic-list');
            container.innerHTML = '';

            let totalJuniors = 0;
            let totalMembers = 0;
            let totalGuests = 0;
            let totalSocial = 0;

            CLINICS.forEach(clinic => {
                const players = rosterData[clinic.name] || [];
                const btn = document.createElement('button');
                btn.className = 'clinic-btn';
                btn.setAttribute('data-clinic', clinic.name);
                btn.innerHTML = `
                    <span class="clinic-icon"></span>
                    ${clinic.display}
                    <span class="counter" style="float:right;">${players.length} players</span>
                `;
                btn.onclick = () => selectClinic(clinic);
                container.appendChild(btn);

                totalJuniors += players.length;
                players.forEach(p => {
                    if (p.status === 'G') totalGuests++;
                    else if (p.status === 'S') totalSocial++;
                    else totalMembers++;
                });
            });

            // Show total juniors tracker
            const totalBar = document.getElementById('total-juniors');
            document.getElementById('total-juniors-count').textContent = totalJuniors;
            document.getElementById('total-members-count').textContent = totalMembers;
            document.getElementById('total-guests-count').textContent = totalGuests;
            document.getElementById('total-social-count').textContent = totalSocial;
            totalBar.style.display = '';
        }

        function selectClinic(clinic) {
            selectedClinic = clinic;
            showRollScreen();
        }

        // ==================== SCREEN NAVIGATION ====================
        function showClinicScreen() {
            document.getElementById('clinic-screen').classList.add('active');
            document.getElementById('roll-screen').classList.remove('active');
            // Refresh rosters each time we go back
            loadAllRosters();
        }

        function showRollScreen() {
            document.getElementById('clinic-screen').classList.remove('active');
            document.getElementById('roll-screen').classList.add('active');

            document.getElementById('selected-clinic-name').textContent = selectedClinic.display;

            // Set date picker to today
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = (today.getMonth() + 1).toString().padStart(2, '0');
            const dd = today.getDate().toString().padStart(2, '0');
            document.getElementById('roll-date-input').value = `${yyyy}-${mm}-${dd}`;
            updateHeaderDate();

            // Clear the add-player input
            document.getElementById('add-player-input').value = '';

            renderCoaches();
            renderPlayers();
            updateSubmitButton();
            hideError();
        }

        function updateHeaderDate() {
            const input = document.getElementById('roll-date-input');
            const parts = input.value.split('-');
            const d = new Date(parts[0], parts[1] - 1, parts[2]);
            const dateStr = d.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('roll-date').textContent = dateStr;
        }

        // Listen for date changes
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('roll-date-input').addEventListener('change', updateHeaderDate);
        });

        // ==================== COACHES ====================
        function renderCoaches() {
            const container = document.getElementById('coaches-list');
            container.innerHTML = '';

            COACHES.forEach(coach => {
                const item = document.createElement('div');
                item.className = 'checklist-item';
                item.innerHTML = `
                    <div class="checkbox"><span class="checkmark">&#10003;</span></div>
                    <span class="name">${coach}</span>
                `;
                item.onclick = () => {
                    item.classList.toggle('checked');
                    updateSubmitButton();
                };
                container.appendChild(item);
            });
        }

        // ==================== PLAYERS ====================
        function renderPlayers() {
            const container = document.getElementById('players-list');
            container.innerHTML = '';

            const players = rosterData[selectedClinic.name] || [];

            if (players.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">No players on roster. Use "Add" below for walk-ins.</div>';
                updatePlayerCounter();
                return;
            }

            players.forEach(player => {
                addPlayerToList(container, player.name, player.status, false);
            });

            updatePlayerCounter();
        }

        function addPlayerToList(container, name, status, isAdded) {
            const item = document.createElement('div');
            item.className = 'checklist-item';

            let badgeHTML = '';
            if (isAdded) {
                badgeHTML = '<span class="added-tag">Added</span>';
            }
            if (!selectedClinic.hideBadge) {
                if (status === 'G') {
                    badgeHTML += '<span class="badge guest">Guest</span>';
                } else if (status === 'S') {
                    badgeHTML += '<span class="badge social">Social</span>';
                } else {
                    badgeHTML += '<span class="badge member">Member</span>';
                }
            }

            item.innerHTML = `
                <div class="checkbox"><span class="checkmark">&#10003;</span></div>
                <span class="name">${name}</span>
                ${badgeHTML}
            `;
            item.setAttribute('data-status', status);
            item.onclick = () => {
                item.classList.toggle('checked');
                updatePlayerCounter();
                updateSubmitButton();
            };

            // If this is an added player, auto-check them and add to end
            if (isAdded) {
                item.classList.add('checked');
                container.appendChild(item);
            } else {
                container.appendChild(item);
            }
        }

        function addPlayer() {
            const input = document.getElementById('add-player-input');
            const name = input.value.trim();

            if (!name) return;

            const container = document.getElementById('players-list');

            // Remove the "no players" message if present
            const noPlayersMsg = container.querySelector('div[style]');
            if (noPlayersMsg && noPlayersMsg.textContent.includes('No players')) {
                container.innerHTML = '';
            }

            // Use the selected type (Member or Guest)
            const status = document.getElementById('add-player-type').value;
            addPlayerToList(container, name, status, true);

            input.value = '';
            updatePlayerCounter();
            updateSubmitButton();

            // Scroll to the new player
            container.lastChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Allow Enter key to add player
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('add-player-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addPlayer();
                }
            });
        });

        function updatePlayerCounter() {
            const items = document.querySelectorAll('#players-list .checklist-item');
            const checked = document.querySelectorAll('#players-list .checklist-item.checked');
            document.getElementById('player-counter').textContent = `(${checked.length}/${items.length})`;
        }

        function toggleSelectAllPlayers() {
            const items = document.querySelectorAll('#players-list .checklist-item');
            const allChecked = Array.from(items).every(item => item.classList.contains('checked'));

            items.forEach(item => {
                if (allChecked) {
                    item.classList.remove('checked');
                } else {
                    item.classList.add('checked');
                }
            });

            updatePlayerCounter();
            updateSubmitButton();
        }

        // ==================== SUBMIT ====================
        function updateSubmitButton() {
            const coaches = document.querySelectorAll('#coaches-list .checklist-item.checked');
            const players = document.querySelectorAll('#players-list .checklist-item.checked');
            const btn = document.getElementById('submit-btn');

            if (coaches.length === 0) {
                btn.disabled = true;
                btn.textContent = 'Select at least one coach';
            } else if (players.length === 0) {
                btn.disabled = true;
                btn.textContent = 'Select at least one player';
            } else {
                btn.disabled = false;
                btn.textContent = `Submit Attendance (${players.length} players)`;
            }
        }

        async function submitRoll() {
            if (!APPS_SCRIPT_URL) {
                APPS_SCRIPT_URL = prompt('Enter the Google Apps Script Web App URL:');
                if (APPS_SCRIPT_URL) {
                    localStorage.setItem('ijta_apps_script_url', APPS_SCRIPT_URL);
                } else {
                    return;
                }
            }

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            hideError();

            // Gather data — use the date from the picker
            const dateParts = document.getElementById('roll-date-input').value.split('-');
            const dateStr = `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;

            const coaches = Array.from(document.querySelectorAll('#coaches-list .checklist-item.checked'))
                .map(item => item.querySelector('.name').textContent);

            const checkedItems = document.querySelectorAll('#players-list .checklist-item.checked');
            const players = Array.from(checkedItems).map(item => ({
                name: item.querySelector('.name').textContent,
                status: item.getAttribute('data-status') || 'M'
            }));

            const payload = {
                date: dateStr,
                clinic: selectedClinic.display,
                clinicTab: selectedClinic.tab,
                coaches: coaches,
                players: players
            };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(players.length, coaches);
                } else {
                    throw new Error(result.error || 'Unknown server error');
                }
            } catch (error) {
                console.error('Submit error:', error);
                showError('Failed to submit attendance. Please check your connection and try again.');
                btn.disabled = false;
                btn.textContent = 'Retry Submit';
            }
        }

        function showError(msg) {
            const el = document.getElementById('error-message');
            el.textContent = msg;
            el.classList.add('visible');
        }

        function hideError() {
            document.getElementById('error-message').classList.remove('visible');
        }

        function showSuccess(playerCount, coaches) {
            document.getElementById('success-message').textContent =
                `${playerCount} player${playerCount !== 1 ? 's' : ''} recorded for ${selectedClinic.display} with ${coaches.join(', ')}.`;
            document.getElementById('success-overlay').classList.add('active');
        }

        function dismissSuccess() {
            document.getElementById('success-overlay').classList.remove('active');
            showClinicScreen();
        }
    </script>
</body>
</html>
